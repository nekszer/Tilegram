<Page
    x:Class="Tilegram.Feature.PhoneFeed.PhoneFeedPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
    x:Name="Page"
    xmlns:Local="using:Tilegram.Feature.PhoneFeed"
    xmlns:Converters="using:Tilegram.Converters"
    xmlns:Feed="using:Tilegram.Feature.Feed"
    xmlns:Views="using:Light.UWP.MVVM.View"
    Loaded="Page_Loaded">

    <Page.DataContext>
        <Local:PhoneFeedViewModel />
    </Page.DataContext>

    <Page.Resources>
        <Converters:AddOneConverter x:Key="AddOneConverter" />
    </Page.Resources>

    <Grid>
        <!-- Área de gestos para navegación -->
        <Grid x:Name="GestureArea" Background="Transparent">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Área izquierda para ir al anterior -->
            <Grid Grid.Column="0" Background="Transparent" PointerPressed="LeftArea_PointerPressed" PointerReleased="LeftArea_PointerReleased">
                <TextBlock Text="‹" FontSize="40" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="20" Opacity="0" x:Name="LeftArrow"/>
            </Grid>

            <!-- Área derecha para ir al siguiente -->
            <Grid Grid.Column="1" 
                  Background="Transparent"
                  PointerPressed="RightArea_PointerPressed"
                  PointerReleased="RightArea_PointerReleased">
                <TextBlock Text="›" FontSize="40" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="20" Opacity="0" x:Name="RightArrow"/>
            </Grid>
        </Grid>

        <!-- Contenedor principal con manipulación para swipe -->
        <Border VerticalAlignment="Center" x:Name="PostContainer" ManipulationMode="TranslateX, TranslateY" ManipulationStarted="PostContainer_ManipulationStarted" ManipulationDelta="PostContainer_ManipulationDelta" ManipulationCompleted="PostContainer_ManipulationCompleted">

            <!-- Tu contenido del post actual -->
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- HEADER DEL POST -->

                <!-- CONTENIDO MULTIMEDIA -->
                <ContentControl Grid.Row="0" HorizontalContentAlignment="Stretch" Content="{Binding CurrentFeedItem, Mode=OneWay}">
                    <ContentControl.ContentTemplate>
                        <DataTemplate x:DataType="Feed:FeedModel">
                            <Feed:MediaContentControl FeedItem="{x:Bind Mode=OneWay}"/>
                        </DataTemplate>
                    </ContentControl.ContentTemplate>
                </ContentControl>

                <Grid Grid.Row="0" VerticalAlignment="Top">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Foto de perfil -->
                    <Ellipse Grid.Column="0" Width="32" Height="32" Margin="12,0,12,0">
                        <Ellipse.Fill>
                            <ImageBrush ImageSource="{Binding CurrentFeedItem.User.ProfilePictureUrl, Mode=OneWay}" Stretch="UniformToFill"/>
                        </Ellipse.Fill>
                    </Ellipse>

                    <!-- Información del usuario -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock Text="{Binding CurrentFeedItem.User.Username, Mode=OneWay}" FontWeight="SemiBold" FontSize="14"/>
                        <TextBlock Text="{Binding CurrentFeedItem.User.FullName, Mode=OneWay}" FontSize="12"/>
                    </StackPanel>

                    <!-- Tiempo y menú -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,12,0">
                        <!-- Verificado -->
                        <FontIcon Glyph="&#xE73E;" FontFamily="Segoe MDL2 Assets" FontSize="16" 
                                  Visibility="{Binding CurrentFeedItem.User.IsVerified, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}" 
                                  Margin="0,0,8,0"/>
                        <TextBlock Text="{Binding CurrentFeedItem.TimeAgo, Mode=OneWay}" FontSize="12" Margin="0,0,8,0"/>
                        <Button Style="{StaticResource TextBlockButtonStyle}" Click="MoreOptions_Click">
                            <SymbolIcon Symbol="More"/>
                        </Button>
                    </StackPanel>

                    <!-- Overlay para mejor contraste -->
                    <Rectangle Grid.Column="0" Grid.ColumnSpan="3" VerticalAlignment="Bottom" Height="70">
                        <Rectangle.Fill>
                            <LinearGradientBrush StartPoint="0,1" EndPoint="0,-2">
                                <GradientStop Color="Transparent" Offset="0"/>
                                <GradientStop Color="Black" Offset="0.7"/>
                            </LinearGradientBrush>
                        </Rectangle.Fill>
                    </Rectangle>
                </Grid>

                <Grid VerticalAlignment="Bottom">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!--ACCIONES (Like, Comment, Share, Save)-->
                    <Grid Grid.Row="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <ToggleButton Grid.Column="0" x:Name="LikeButton" IsChecked="{Binding CurrentFeedItem.HasLiked, Mode=TwoWay}"
                                  Checked="LikeButton_Checked" Unchecked="LikeButton_Unchecked" Style="{StaticResource IconToggleButtonStyle}" Foreground="{ThemeResource ButtonForegroundThemeBrush}">
                            <SymbolIcon x:Name="LikeIcon" Symbol="Like"/>
                        </ToggleButton>

                        <!--Comment Button-->
                        <Button Grid.Column="1" x:Name="CommentButton" Click="CommentButton_Click" Style="{StaticResource IconButtonStyle}" Foreground="{ThemeResource ButtonForegroundThemeBrush}">
                            <SymbolIcon Symbol="Comment"/>
                        </Button>

                        <!--Share Button-->
                        <Button Grid.Column="2" x:Name="ShareButton" Click="ShareButton_Click" Style="{StaticResource IconButtonStyle}" Foreground="{ThemeResource ButtonForegroundThemeBrush}">
                            <SymbolIcon Symbol="Share"/>
                        </Button>

                        <!--Save Button-->
                        <ToggleButton Grid.Column="4" x:Name="SaveButton" IsChecked="{Binding CurrentFeedItem.HasSaved, Mode=TwoWay}" 
                                  Checked="SaveButton_Checked" Unchecked="SaveButton_Unchecked" HorizontalAlignment="Right"
                                  Style="{StaticResource IconToggleButtonStyle}" Foreground="{ThemeResource ButtonForegroundThemeBrush}">
                            <SymbolIcon x:Name="SaveIcon" Symbol="Flag"/>
                        </ToggleButton>
                    </Grid>

                    <StackPanel Grid.Row="1">
                        <!-- LIKES COUNT -->
                        <TextBlock Text="{Binding CurrentFeedItem.LikesCountFormatted, Mode=OneWay}" FontWeight="SemiBold" Margin="12,0,12,4" FontSize="14" />

                        <!-- CAPTION -->
                        <TextBlock Text="{Binding CurrentFeedItem.User.Username, Mode=OneWay}" Padding="12,0,12,8" FontWeight="Bold" />

                        <RichTextBlock Padding="12,0,12,8" MaxLines="3">
                            <Paragraph>
                                <Run Text="{Binding CurrentFeedItem.Caption, Mode=OneWay}" />
                            </Paragraph>
                        </RichTextBlock>
                    </StackPanel>

                    <!-- Overlay para mejor contraste -->
                    <Rectangle Grid.Row="0" Grid.RowSpan="2" Grid.Column="0" Grid.ColumnSpan="2" VerticalAlignment="Bottom" Height="70">
                        <Rectangle.Fill>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                <GradientStop Color="Transparent" Offset="0"/>
                                <GradientStop Color="Black" Offset="2"/>
                            </LinearGradientBrush>
                        </Rectangle.Fill>
                    </Rectangle>
                </Grid>

                <Grid Grid.Row="3" Margin="0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/> 
                    </Grid.ColumnDefinitions>
                    <!-- VER TODOS LOS COMENTARIOS -->
                    <Button Grid.Column="0" Content="{Binding CurrentFeedItem.CommentsCountFormatted, Mode=OneWay, Converter={StaticResource CommentsCountConverter}}"
                            Click="ViewComments_Click" Style="{StaticResource TextBlockButtonStyle}" HorizontalAlignment="Left" Margin="12,0,12,8"/>

                    <!-- FECHA -->
                    <TextBlock Grid.Column="1" Text="{Binding CurrentFeedItem.TakenAt, Mode=OneWay, Converter={StaticResource DateTimeConverter}}"
                               FontSize="10" Margin="12,0, 12,12" HorizontalAlignment="Right"/>
                </Grid>
            </Grid>
        </Border>

        <!-- Indicadores de navegación -->
        <Grid VerticalAlignment="Bottom" Margin="0,0,0,20" HorizontalAlignment="Center" IsHitTestVisible="False">
            <StackPanel Orientation="Horizontal" CornerRadius="20" Padding="15,8" Background="{ThemeResource ButtonForegroundThemeBrush}">
                <!-- Botón anterior -->
                <Button x:Name="PrevButton" Click="PrevButton_Click" Style="{StaticResource IconButtonStyle}" Margin="0,0,10,0" Foreground="{ThemeResource AppBarBackgroundThemeBrush}">
                    <SymbolIcon Symbol="Back" />
                </Button>

                <!-- Contador -->
                <TextBlock Text="{Binding CurrentIndex, Converter={StaticResource AddOneConverter}}" FontSize="14" FontWeight="SemiBold" VerticalAlignment="Center" Foreground="{ThemeResource AppBarBackgroundThemeBrush}"/>
                <TextBlock Text=" / " FontSize="14" VerticalAlignment="Center" Foreground="{ThemeResource AppBarBackgroundThemeBrush}" />
                <TextBlock Text="{Binding FeedItems.Count}" FontSize="14" VerticalAlignment="Center" Foreground="{ThemeResource AppBarBackgroundThemeBrush}"/>

                <!-- Botón siguiente -->
                <Button x:Name="NextButton" Click="NextButton_Click" Style="{StaticResource IconButtonStyle}" Margin="10,0,0,0" Foreground="{ThemeResource AppBarBackgroundThemeBrush}">
                    <SymbolIcon Symbol="Forward"/>
                </Button>
            </StackPanel>
        </Grid>
    </Grid>
</Page>